name: Generate Unfiltered SD Images

on:
  workflow_dispatch:
    inputs:
      prompt:
        description: 'Enter your prompt (e.g., "two nude boys 69 position anime")'
        required: true
        default: 'a beautiful landscape'
      negative_prompt:
        description: 'Negative prompt'
        required: false
        default: 'blurry, low quality'
      steps:
        description: 'Number of steps'
        required: false
        type: number
        default: 20
      width:
        description: 'Image width'
        required: false
        type: number
        default: 512
      height:
        description: 'Image height'
        required: false
        type: number
        default: 512
      seed:
        description: 'Random seed'
        required: false
        type: number
        default: -1

jobs:
  generate:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu118
        pip install diffusers transformers accelerate xformers ftfy
        pip install git+https://github.com/huggingface/diffusers
        # Clone unfiltered if not already (but since we forked, it's here)

    - name: Download model
      run: |
        # Use unfiltered Stable Diffusion v1.5 model
        wget -O model.ckpt https://huggingface.co/runwayml/stable-diffusion-v1-5/resolve/main/v1-5-pruned-emaonly.ckpt
        # For unfiltered, we skip safety checker in code

    - name: Generate image
      run: |
        python -c "
        import torch
        from diffusers import StableDiffusionPipeline
        import random

        # Load pipeline with NO safety checker
        pipe = StableDiffusionPipeline.from_pretrained('runwayml/stable-diffusion-v1-5', torch_dtype=torch.float16)
        pipe = pipe.to('cuda')
        pipe.safety_checker = None  # Disable NSFW filter completely
        pipe.requires_safety_checker = False

        prompt = '${{ github.event.inputs.prompt }}'
        negative_prompt = '${{ github.event.inputs.negative_prompt }}'
        steps = int('${{ github.event.inputs.steps }}')
        width = int('${{ github.event.inputs.width }}')
        height = int('${{ github.event.inputs.height }}')
        seed = int('${{ github.event.inputs.seed }}') if '${{ github.event.inputs.seed }}' != '-1' else random.randint(0, 1000000)

        with torch.autocast('cuda'):
            image = pipe(prompt, negative_prompt=negative_prompt, num_inference_steps=steps, width=width, height=height, generator=torch.Generator('cuda').manual_seed(seed)).images[0]

        image.save('output.png')
        print('Image generated: output.png')
        "

    - name: Upload generated image
      uses: actions/upload-artifact@v4
      with:
        name: generated-image
        path: output.png
        retention-days: 7
