name: SD Unfiltered Anime (Fixed Model Load)

on:
  workflow_dispatch:
    inputs:
      prompt:
        description: '你的硬核描述'
        default: 'masterpiece, best quality, 2boys, yaoi, full nude, anime style, side view 69 position, mutual deepthroat, explicit, uncensored, sweat, drool, ahegao'
        required: true
      negative_prompt:
        default: 'blurry, ugly, deformed, censored, bar'
      steps:
        default: '28'
      num_images:
        description: '一次出几张'
        default: '4'

jobs:
  generate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Free disk space (清垃圾)
        run: |
          sudo rm -rf /usr/share/dotnet /opt/ghc "/usr/local/share/boost" "$AGENT_TOOLSDIRECTORY"
          df -h  # 检查空间

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install libs (no cache to save space)
        run: |
          pip install --no-cache-dir torch torchvision --index-url https://download.pytorch.org/whl/cu118
          pip install --no-cache-dir diffusers[torch] transformers accelerate safetensors ftfy

      - name: Download Anything V4.5 model (2GB anime unfiltered)
        run: |
          wget -O anything-v4.5-pruned.safetensors https://huggingface.co/andite/anything-v4.0/resolve/main/anything-v4.5-pruned.safetensors

      - name: Generate images (no safety checker)
        run: |
          python - <<'EOF'
          import torch
          import random
          from diffusers import StableDiffusionPipeline
          from safetensors.torch import load_file

          # 直接从 safetensors 文件加载 Anything V4.5 (动漫专用，无过滤)
          pipe = StableDiffusionPipeline.from_single_file(
              "anything-v4.5-pruned.safetensors",
              torch_dtype=torch.float16,
              use_safetensors=True,
              safety_checker=None,  # 彻底关闭 NSFW 过滤
              requires_safety_checker=False
          )
          pipe.to("cuda")

          prompt = """${{ github.event.inputs.prompt }}"""
          negative = """${{ github.event.inputs.negative_prompt }}"""
          steps = int("${{ github.event.inputs.steps }}")
          num = int("${{ github.event.inputs.num_images }}")

          for i in range(num):
              seed = random.randint(1, 999999999)
              gen = torch.Generator("cuda").manual_seed(seed)
              image = pipe(
                  prompt, 
                  negative_prompt=negative, 
                  num_inference_steps=steps,
                  generator=gen
              ).images[0]
              image.save(f"output_{i+1}.png")
              print(f"Generated output_{i+1}.png - Seed: {seed}")
          EOF

      - name: Upload images
        uses: actions/upload-artifact@v4
        with:
          name: anime-uncensored-images
          path: output_*.png
          retention-days: 7
