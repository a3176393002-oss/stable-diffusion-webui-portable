name: SD Unfiltered (No Disk Full)

on:
  workflow_dispatch:
    inputs:
      prompt:
        description: '你的硬核描述'
        default: 'masterpiece, best quality, 2boys, yaoi, full nude, anime style, side view 69 position, mutual deepthroat, explicit, uncensored, sweat, drool, ahegao'
        required: true
      negative_prompt:
        default: 'blurry, ugly, deformed, censored, bar'
      steps:
        default: '28'
      num_images:
        description: '一次出几张'
        default: '4'

jobs:
  generate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Free disk space (关键一步！)
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf "/usr/local/share/boost"
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
          df -h

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install tiny libs
        run: |
          pip install --no-cache-dir torch torchvision --index-url https://download.pytorch.org/whl/cu118
          pip install --no-cache-dir diffusers transformers accelerate safetensors

      - name: Generate 4 images (no safety checker)
        run: |
          python - <<'EOF'
          import torch, random, os
          from diffusers import StableDiffusionPipeline

          model_id = "ckpt/anything-v4.5-pruned"           # 只要 2.1GB！
          pipe = StableDiffusionPipeline.from_pretrained(
              model_id,
              torch_dtype=torch.float16,
              safety_checker=None,          # 彻底关闭过滤
              requires_safety_checker=False
          )
          pipe.to("cuda")

          prompt = """${{ github.event.inputs.prompt }}"""
          negative = """${{ github.event.inputs.negative_prompt }}"""
          steps = int("${{ github.event.inputs.steps }}")
          num = int("${{ github.event.inputs.num_images }}")

          for i in range(num):
              seed = random.randint(1, 999999999)
              image = pipe(prompt, negative_prompt=negative, num_inference_steps=steps,
                           generator=torch.Generator("cuda").manual_seed(seed)).images[0]
              image.save(f"output_{i+1}.png")
              print(f"第 {i+1} 张生成完毕")
          EOF

      - name: Upload images
        uses: actions/upload-artifact@v4
        with:
          name: uncensored-images
          path: output_*.png
